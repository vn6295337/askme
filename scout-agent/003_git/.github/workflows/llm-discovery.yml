name: LLM Discovery and Export

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger
  push:
    branches: [ main, master ]
    paths:
      - 'scout-agent/100_src/**'
      - 'scout-agent/001_config/**'
      - 'scout-agent/003_git/.github/workflows/llm-discovery.yml'

jobs:
  discover-and-export:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'scout-agent/001_config/package.json'
        
    - name: Install dependencies
      run: |
        cd scout-agent
        npm install --prefix 999_node_modules
        
    - name: Create environment file
      run: |
        cd scout-agent
        cat > 002_env/.env << EOF
        BACKEND_URL=${{ secrets.BACKEND_URL || 'https://askme-backend-proxy.onrender.com' }}
        AGENT_AUTH_TOKEN=${{ secrets.AGENT_AUTH_TOKEN || 'default-token' }}
        EOF
        
    - name: Run LLM Discovery
      env:
        BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://askme-backend-proxy.onrender.com' }}
        AGENT_AUTH_TOKEN: ${{ secrets.AGENT_AUTH_TOKEN || 'default-token' }}
      run: |
        cd scout-agent
        echo "Starting LLM discovery..."
        npm start
        
    - name: Verify output files
      run: |
        cd scout-agent
        echo "Checking generated files..."
        ls -la 400_data/
        echo "CSV content preview:"
        head -5 400_data/llm-models-latest.csv || echo "CSV file not found"
        
    - name: Create data directory if not exists
      run: |
        mkdir -p data/exports
        mkdir -p data/reports
        
    - name: Copy files to data directory
      run: |
        cd scout-agent
        # Copy latest files
        cp 400_data/llm-models-latest.csv ../data/exports/llm-models-latest.csv
        
        # Create timestamped copies
        TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
        cp 400_data/llm-models-latest.csv "../data/exports/llm-models-$TIMESTAMP.csv"
        
        echo "Files copied to data directory with timestamp: $TIMESTAMP"
        
    - name: Generate README for data directory
      run: |
        cat > data/README.md << 'EOF'
        # LLM Discovery Data
        
        This directory contains automated LLM discovery data generated by the scout agent.
        
        ## Structure
        
        - `exports/` - CSV data files
          - `llm-models-latest.csv` - Latest discovered models in CSV format
          - `llm-models-YYYY-MM-DD_HH-MM-SS.csv` - Timestamped exports
        
        ## Usage
        
        The CSV files can be imported into spreadsheet applications or data analysis tools.
        
        ## Last Updated
        
        $(date -u)
        EOF
        
    - name: Configure Git
      run: |
        git config user.name "LLM Discovery Bot"
        git config user.email "llm-discovery@github-actions.local"
        
    - name: Commit and push changes
      run: |
        git add data/
        git add output/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          MODELS_COUNT=$(wc -l < scout-agent/400_data/llm-models-latest.csv 2>/dev/null || echo "unknown")
          
          git commit -m "📊 LLM Discovery Update - $TIMESTAMP

          🔍 Discovered $MODELS_COUNT models
          📅 Automated discovery run
          🤖 Generated by scout-agent
          
          Files updated:
          - CSV export: data/exports/llm-models-latest.csv"
          
          git push
          echo "Changes pushed successfully!"
        fi
        
    - name: Create Release (if on main/master)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: discovery-${{ github.run_number }}
        release_name: LLM Discovery Run ${{ github.run_number }}
        body: |
          🤖 Automated LLM Discovery Report
          
          **Discovery Date:** $(date -u)
          **Models Found:** $(wc -l < scout-agent/400_data/llm-models-latest.csv 2>/dev/null || echo "unknown")
          
          ### Downloads
          - [CSV Export](../../data/exports/llm-models-latest.csv)
          
          View the complete data in the [data directory](../../tree/main/data).
        draft: false
        prerelease: false
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: llm-discovery-data
        path: |
          scout-agent/400_data/
          data/
        retention-days: 30