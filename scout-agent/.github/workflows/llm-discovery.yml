name: LLM Discovery and Export

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'config/**'
      - '.github/workflows/llm-discovery.yml'

jobs:
  discover-and-export:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        npm install axios cheerio fs-extra
        
    - name: Run LLM Discovery
      env:
        BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://askme-backend-proxy.onrender.com' }}
        AGENT_AUTH_TOKEN: ${{ secrets.AGENT_AUTH_TOKEN || 'default-token' }}
      run: |
        echo "Starting LLM discovery..."
        npm start
        
    - name: Convert JSON to CSV and Markdown
      run: |
        echo "Converting output to CSV and Markdown..."
        node scripts/json-to-csv.js
        
    - name: Verify output files
      run: |
        echo "Checking generated files..."
        ls -la output/
        echo "CSV content preview:"
        head -5 output/llm-models.csv || echo "CSV file not found"
        echo "Summary content preview:"
        head -10 output/discovery-summary.md || echo "Summary file not found"
        
    - name: Create data directory if not exists
      run: |
        mkdir -p data/exports
        mkdir -p data/reports
        
    - name: Copy files to data directory
      run: |
        # Copy latest files
        cp output/llm-models.csv data/exports/llm-models-latest.csv
        cp output/discovery-summary.md data/reports/discovery-summary-latest.md
        cp output/latest-discovery.json data/exports/llm-discovery-latest.json
        
        # Create timestamped copies
        TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
        cp output/llm-models.csv "data/exports/llm-models-$TIMESTAMP.csv"
        cp output/discovery-summary.md "data/reports/discovery-summary-$TIMESTAMP.md"
        cp output/latest-discovery.json "data/exports/llm-discovery-$TIMESTAMP.json"
        
        echo "Files copied to data directory with timestamp: $TIMESTAMP"
        
    - name: Generate README for data directory
      run: |
        cat > data/README.md << 'EOF'
        # LLM Discovery Data
        
        This directory contains automated LLM discovery data generated by the scout agent.
        
        ## Structure
        
        - `exports/` - CSV and JSON data files
          - `llm-models-latest.csv` - Latest discovered models in CSV format
          - `llm-discovery-latest.json` - Latest raw JSON data
          - `llm-models-YYYY-MM-DD_HH-MM-SS.csv` - Timestamped exports
          - `llm-discovery-YYYY-MM-DD_HH-MM-SS.json` - Timestamped raw data
        
        - `reports/` - Markdown summary reports
          - `discovery-summary-latest.md` - Latest summary report
          - `discovery-summary-YYYY-MM-DD_HH-MM-SS.md` - Timestamped reports
        
        ## Usage
        
        The CSV files can be imported into spreadsheet applications or data analysis tools.
        The JSON files contain the complete raw data with metadata.
        The markdown reports provide human-readable summaries.
        
        ## Last Updated
        
        $(date -u)
        EOF
        
    - name: Configure Git
      run: |
        git config user.name "LLM Discovery Bot"
        git config user.email "llm-discovery@github-actions.local"
        
    - name: Commit and push changes
      run: |
        git add data/
        git add output/ || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          MODELS_COUNT=$(jq '.metadata.totalModels' output/latest-discovery.json 2>/dev/null || echo "unknown")
          
          git commit -m "📊 LLM Discovery Update - $TIMESTAMP

          🔍 Discovered $MODELS_COUNT models
          📅 Automated discovery run
          🤖 Generated by scout-agent
          
          Files updated:
          - CSV export: data/exports/llm-models-latest.csv
          - Summary report: data/reports/discovery-summary-latest.md
          - Raw data: data/exports/llm-discovery-latest.json"
          
          git push
          echo "Changes pushed successfully!"
        fi
        
    - name: Create Release (if on main/master)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: discovery-${{ github.run_number }}
        release_name: LLM Discovery Run ${{ github.run_number }}
        body: |
          🤖 Automated LLM Discovery Report
          
          **Discovery Date:** $(date -u)
          **Models Found:** $(jq '.metadata.totalModels' output/latest-discovery.json 2>/dev/null || echo "unknown")
          **Sources:** $(jq -r '.metadata.sources | join(", ")' output/latest-discovery.json 2>/dev/null || echo "unknown")
          
          ### Downloads
          - [CSV Export](../../data/exports/llm-models-latest.csv)
          - [Summary Report](../../data/reports/discovery-summary-latest.md) 
          - [Raw JSON Data](../../data/exports/llm-discovery-latest.json)
          
          View the complete data in the [data directory](../../tree/main/data).
        draft: false
        prerelease: false
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: llm-discovery-data
        path: |
          output/
          data/
        retention-days: 30